name: 删除除主分支之外的所有分支 (Delete All Branches Except Master)

on:
  workflow_dispatch:

jobs:
  cleanup-branches:
    name: 清理分支 (Cleanup Branches)
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: 检出代码 (Checkout code)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: 获取所有远程分支 (Fetch all remote branches)
        run: |
          echo "::group::获取远程分支列表 (Fetching remote branches)"
          git fetch --all
          echo "::endgroup::"
      
      - name: 识别要删除的分支 (Identify branches to delete)
        id: identify
        run: |
          echo "::group::识别除master以外的分支 (Identifying non-master branches)"
          
          # Get all remote branches except master and HEAD
          branches=$(git branch -r | grep -v 'HEAD' | grep -v -E 'origin/master$' | sed 's/origin\///' | sed 's/^[ \t]*//')
          
          if [ -z "$branches" ]; then
            echo "没有需要删除的分支 (No branches to delete)"
            echo "has_branches=false" >> $GITHUB_OUTPUT
          else
            echo "要删除的分支 (Branches to delete):"
            echo "$branches"
            
            # Count branches - use grep -c to count non-empty lines
            count=$(echo "$branches" | grep -c '^')
            echo "总共 $count 个分支将被删除 (Total $count branches will be deleted)"
            
            # Save branches to output
            echo "has_branches=true" >> $GITHUB_OUTPUT
            
            # Save branches to file for next step
            echo "$branches" > /tmp/branches_to_delete.txt
          fi
          
          echo "::endgroup::"
      
      - name: 删除远程分支 (Delete remote branches)
        if: steps.identify.outputs.has_branches == 'true'
        run: |
          echo "::group::删除远程分支 (Deleting remote branches)"
          
          # Use a file to store failed branches for better performance
          failed_branches_file="/tmp/failed_branches.txt"
          > "$failed_branches_file"
          success_count=0
          fail_count=0
          
          while IFS= read -r branch; do
            if [ -n "$branch" ]; then
              echo "正在删除分支 (Deleting branch): $branch"
              
              if git push origin --delete "$branch" 2>&1; then
                echo "✓ 成功删除 (Successfully deleted): $branch"
                success_count=$((success_count + 1))
              else
                echo "✗ 删除失败 (Failed to delete): $branch"
                echo "$branch" >> "$failed_branches_file"
                fail_count=$((fail_count + 1))
              fi
            fi
          done < /tmp/branches_to_delete.txt
          
          echo "::endgroup::"
          
          echo "::group::删除摘要 (Deletion Summary)"
          echo "成功删除 (Successfully deleted): $success_count 个分支 (branches)"
          echo "删除失败 (Failed to delete): $fail_count 个分支 (branches)"
          
          if [ $fail_count -gt 0 ]; then
            echo "::warning::删除失败的分支 (Failed branches):"
            cat "$failed_branches_file"
          fi
          
          echo "::endgroup::"
          
          # Exit with error if any deletions failed
          if [ $fail_count -gt 0 ]; then
            echo "::error::部分分支删除失败 (Some branches failed to delete)"
            exit 1
          fi
      
      - name: 验证清理结果 (Verify cleanup)
        if: steps.identify.outputs.has_branches == 'true'
        run: |
          echo "::group::验证清理结果 (Verifying cleanup result)"
          
          git fetch --prune
          remaining_branches=$(git branch -r | grep -v 'HEAD' | grep -v -E 'origin/master$')
          
          if [ -z "$remaining_branches" ]; then
            echo "✓ 成功：只剩下master分支 (Success: Only master branch remains)"
          else
            echo "⚠ 警告：仍有以下分支存在 (Warning: The following branches still exist):"
            echo "$remaining_branches"
          fi
          
          echo "::endgroup::"
      
      - name: 完成 (Complete)
        run: |
          echo "::notice::分支清理工作流程已完成 (Branch cleanup workflow completed)"
