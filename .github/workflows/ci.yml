name: CI Build and Test

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

# é™åˆ¶ GITHUB_TOKEN çš„æƒé™ / Limit GITHUB_TOKEN permissions
permissions:
  contents: read
  pull-requests: write  # ç”¨äºåœ¨ PR ä¸Šå‘å¸ƒé‡å¤ä»£ç æ£€æµ‹è¯„è®º / Required for posting duplication check comments on PRs

jobs:
  # é‡å¤ä»£ç æ£€æµ‹ä½œä¸š / Duplicate Code Detection Job
  duplicate-code-check:
    name: Duplicate Code Detection (å½±åˆ†èº«æ£€æµ‹)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install jscpd and jq
        run: |
          npm install -g jscpd
          sudo apt-get update && sudo apt-get install -y jq
      
      - name: Run duplicate code detection
        id: jscpd
        run: |
          echo "ğŸ” å¼€å§‹æ£€æµ‹é‡å¤ä»£ç  / Starting duplicate code detection..."
          
          # Run jscpd and capture exit code
          set +e
          jscpd . --pattern "**/*.cs" \
            --ignore "**/bin/**,**/obj/**,**/Migrations/**,**/Tests/**,**/*.Designer.cs" \
            --reporters json,console \
            --output ./jscpd-report \
            --min-lines 10 \
            --min-tokens 50
          JSCPD_EXIT_CODE=$?
          set -e
          
          # Parse results using jq
          if [ -f "./jscpd-report/jscpd-report.json" ]; then
            DUPLICATE_PERCENTAGE=$(jq -r '.statistics.total.percentage' ./jscpd-report/jscpd-report.json | xargs printf "%.2f")
            CLONE_COUNT=$(jq -r '.statistics.total.clones' ./jscpd-report/jscpd-report.json)
            DUPLICATED_LINES=$(jq -r '.statistics.total.duplicatedLines' ./jscpd-report/jscpd-report.json)
            
            echo "duplicate_percentage=${DUPLICATE_PERCENTAGE}" >> $GITHUB_OUTPUT
            echo "clone_count=${CLONE_COUNT}" >> $GITHUB_OUTPUT
            echo "duplicated_lines=${DUPLICATED_LINES}" >> $GITHUB_OUTPUT
            
            echo ""
            echo "ğŸ“Š é‡å¤ä»£ç æ£€æµ‹ç»“æœ / Duplicate Code Detection Results:"
            echo "============================================"
            echo "é‡å¤ä»£ç æ¯”ä¾‹ / Duplication Rate: ${DUPLICATE_PERCENTAGE}%"
            echo "é‡å¤ä»£ç å—æ•° / Clone Count: ${CLONE_COUNT}"
            echo "é‡å¤ä»£ç è¡Œæ•° / Duplicated Lines: ${DUPLICATED_LINES}"
            echo "============================================"
          else
            # jscpd failed and no report generated - this is an error condition
            if [ $JSCPD_EXIT_CODE -ne 0 ]; then
              echo "âŒ jscpd failed with exit code ${JSCPD_EXIT_CODE}"
              exit 1
            fi
            echo "âš ï¸ No report generated - treating as 0% duplication"
            echo "duplicate_percentage=0" >> $GITHUB_OUTPUT
            echo "clone_count=0" >> $GITHUB_OUTPUT
            echo "duplicated_lines=0" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload duplication report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: duplication-report
          path: ./jscpd-report/
      
      - name: Check duplication threshold
        run: |
          THRESHOLD=5
          PERCENTAGE=${{ steps.jscpd.outputs.duplicate_percentage }}
          
          echo "å½“å‰é‡å¤ä»£ç æ¯”ä¾‹ / Current duplication rate: ${PERCENTAGE}%"
          echo "é˜ˆå€¼ / Threshold: ${THRESHOLD}%"
          
          # Use awk for portable floating-point comparison
          if awk "BEGIN {exit !($PERCENTAGE > $THRESHOLD)}"; then
            echo ""
            echo "âŒ é‡å¤ä»£ç æ£€æµ‹å¤±è´¥ / Duplicate Code Detection Failed!"
            echo "ä»£ç é‡å¤ç‡ ${PERCENTAGE}% è¶…è¿‡äº†é˜ˆå€¼ ${THRESHOLD}%"
            echo "Code duplication rate ${PERCENTAGE}% exceeds threshold ${THRESHOLD}%"
            echo ""
            echo "ğŸ“– è¯·å‚è€ƒ TECHNICAL_DEBT.md äº†è§£å¦‚ä½•è§£å†³é‡å¤ä»£ç é—®é¢˜"
            echo "Please refer to TECHNICAL_DEBT.md for guidance on resolving duplicate code"
            exit 1
          else
            echo ""
            echo "âœ… é‡å¤ä»£ç æ£€æµ‹é€šè¿‡ / Duplicate Code Detection Passed!"
            echo "ä»£ç é‡å¤ç‡ ${PERCENTAGE}% åœ¨é˜ˆå€¼ ${THRESHOLD}% ä»¥å†…"
            echo "Code duplication rate ${PERCENTAGE}% is within threshold ${THRESHOLD}%"
          fi
      
      - name: Add duplication PR comment
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: duplication-check
          message: |
            ## ğŸ” é‡å¤ä»£ç æ£€æµ‹ç»“æœ / Duplicate Code Detection Results
            
            | æŒ‡æ ‡ Metric | å€¼ Value |
            |-------------|----------|
            | é‡å¤ä»£ç æ¯”ä¾‹ Duplication Rate | ${{ steps.jscpd.outputs.duplicate_percentage }}% |
            | é‡å¤ä»£ç å—æ•° Clone Count | ${{ steps.jscpd.outputs.clone_count }} |
            | é‡å¤ä»£ç è¡Œæ•° Duplicated Lines | ${{ steps.jscpd.outputs.duplicated_lines }} |
            | é˜ˆå€¼ Threshold | 5% |
            
            ---
            ğŸ“– è¯¦æƒ…è¯·æŸ¥çœ‹ [TECHNICAL_DEBT.md](../TECHNICAL_DEBT.md)

  # å½±åˆ†èº«è¯­ä¹‰æ£€æµ‹ä½œä¸š / Shadow Clone Semantic Detection Job
  shadow-clone-check:
    name: Shadow Clone Semantic Detection (å½±åˆ†èº«è¯­ä¹‰æ£€æµ‹)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      
      - name: Build shadow clone detector
        run: |
          echo "ğŸ”§ æ„å»ºå½±åˆ†èº«æ£€æµ‹å·¥å…· / Building shadow clone detector..."
          cd Tools/ShadowCloneDetector
          dotnet build --configuration Release --nologo
      
      - name: Run shadow clone detection
        id: shadow_clone
        run: |
          echo "ğŸ” è¿è¡Œå½±åˆ†èº«è¯­ä¹‰æ£€æµ‹ / Running shadow clone semantic detection..."
          echo "æ£€æµ‹ç±»å‹ / Detection types: æšä¸¾/æ¥å£/DTO/Options/æ‰©å±•æ–¹æ³•/é™æ€ç±»/å¸¸é‡"
          echo "Enums/Interfaces/DTOs/Options/Extension Methods/Static Classes/Constants"
          echo ""
          
          cd Tools/ShadowCloneDetector
          set +e
          # Run once with tee to capture both JSON output and display to console
          dotnet run --configuration Release --no-build -- ../.. --threshold 0.80 --json 2>&1 | tee shadow-clone-report.json
          SHADOW_EXIT_CODE=${PIPESTATUS[0]}
          set -e
          
          echo "shadow_exit_code=${SHADOW_EXIT_CODE}" >> $GITHUB_OUTPUT
          
          if [ $SHADOW_EXIT_CODE -eq 0 ]; then
            echo ""
            echo "âœ… å½±åˆ†èº«è¯­ä¹‰æ£€æµ‹é€šè¿‡ / Shadow clone semantic detection passed"
          else
            echo ""
            echo "âš ï¸  å‘ç°å½±åˆ†èº«ä»£ç  / Shadow clone code detected"
          fi
      
      - name: Upload shadow clone report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: shadow-clone-report
          path: Tools/ShadowCloneDetector/shadow-clone-report.json
      
      - name: Check shadow clone detection results
        run: |
          SHADOW_EXIT_CODE=${{ steps.shadow_clone.outputs.shadow_exit_code }}
          
          if [ "$SHADOW_EXIT_CODE" != "0" ]; then
            echo ""
            echo "âŒ å½±åˆ†èº«è¯­ä¹‰æ£€æµ‹å¤±è´¥ / Shadow Clone Semantic Detection Failed!"
            echo "å‘ç°äº†ä»¥ä¸‹ç±»å‹çš„é‡å¤ä»£ç  / Found the following types of duplicate code:"
            echo "  - æšä¸¾è¯­ä¹‰é‡å¤ / Enum semantic duplicates"
            echo "  - æ¥å£æ–¹æ³•ç­¾åé‡å  / Interface method signature overlaps"
            echo "  - DTO å­—æ®µç»“æ„ç›¸åŒ / DTO field structure duplicates"
            echo "  - Options/é…ç½®ç±»é‡å¤ / Options/Config class duplicates"
            echo "  - æ‰©å±•æ–¹æ³•ç­¾åç›¸åŒ / Extension method signature duplicates"
            echo "  - é™æ€ç±»åŠŸèƒ½é‡å¤ / Static class functionality duplicates"
            echo "  - å¸¸é‡å€¼ç›¸åŒ / Constant value duplicates"
            echo ""
            echo "ğŸ“– è¯·å‚è€ƒä¸Šé¢çš„æ£€æµ‹ç»“æœè¯¦æƒ…è¿›è¡Œä¿®å¤"
            echo "ğŸ“– Please refer to the detection results above for fixes"
            echo ""
            echo "âš ï¸  è­¦å‘Šï¼šå‘ç°å½±åˆ†èº«ä»£ç ï¼Œå»ºè®®ä¿®å¤åå†åˆå¹¶"
            echo "âš ï¸  Warning: Shadow clone code detected, recommend fixing before merging"
            # æš‚æ—¶åªè­¦å‘Šï¼Œä¸å¼ºåˆ¶å¤±è´¥ / Only warn for now, don't enforce failure
            # exit 1
          else
            echo ""
            echo "âœ… å½±åˆ†èº«è¯­ä¹‰æ£€æµ‹é€šè¿‡ / Shadow Clone Semantic Detection Passed!"
          fi

  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    needs: [duplicate-code-check, shadow-clone-check]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      
      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-
      
      - name: Restore dependencies
        run: dotnet restore
      
      - name: Build solution
        run: dotnet build --configuration Release --no-restore
      
      - name: Run unit tests
        run: dotnet test --configuration Release --no-build --verbosity normal --logger "trx;LogFileName=test-results.trx"
      
      - name: Generate code coverage report
        run: |
          dotnet test --configuration Release --no-build --collect:"XPlat Code Coverage" --results-directory ./coverage
      
      - name: Install ReportGenerator
        run: dotnet tool install --global dotnet-reportgenerator-globaltool
      
      - name: Generate coverage HTML report
        run: |
          reportgenerator \
            -reports:"./coverage/**/coverage.cobertura.xml" \
            -targetdir:"./coverage/report" \
            -reporttypes:"Html;TextSummary"
      
      - name: Display coverage summary
        run: cat ./coverage/report/Summary.txt
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: '**/test-results.trx'
      
      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: ./coverage/report/
      
      - name: Code Coverage Summary
        uses: irongut/CodeCoverageSummary@v1.3.0
        with:
          filename: 'coverage/**/coverage.cobertura.xml'
          badge: true
          fail_below_min: true
          format: markdown
          hide_branch_rate: false
          hide_complexity: false
          indicators: true
          output: both
          thresholds: '60 80'
      
      - name: Add Coverage PR Comment
        uses: marocchino/sticky-pull-request-comment@v2
        if: github.event_name == 'pull_request'
        with:
          recreate: true
          path: code-coverage-results.md
      
      - name: Quality Gate - Check Coverage Threshold
        run: |
          coverage_percentage=$(grep -oP 'Line coverage: \K[\d.]+' ./coverage/report/Summary.txt || echo "0")
          echo "Current code coverage: ${coverage_percentage}%"
          # Use awk for portable floating-point comparison
          if awk "BEGIN {exit !($coverage_percentage < 60)}"; then
            echo "âŒ Code coverage ${coverage_percentage}% is below the minimum threshold of 60% (target: 80%)"
            exit 1
          else
            echo "âœ… Code coverage ${coverage_percentage}% meets the minimum threshold of 60% (target: 80%)"
          fi
